{% extends "index.html" %}

{% block title %}Recommend{% endblock %}

{% block content %}
<h1 class="text-info mb-4">Movie Recommendations</h1>

<!-- FILTER + SEARCH -->
<div class="row mb-3">
    <div class="col-md-4">
        <select id="feature_filter" class="form-select">
            <option value="">-- Filter by Genre --</option>
            {% for g in all_genres %}
                <option value="{{ g }}">{{ g }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-6">
        <input type="text" id="search_input" class="form-control" placeholder="Search movie by title...">
    </div>
    <div class="col-md-2">
        <button id="search_btn" class="btn btn-info w-100">Search</button>
    </div>
</div>

<!-- MOVIE CARDS CONTAINER -->
<div class="row" id="movies_container">
    <!-- Movie cards sẽ được inject bằng JS -->
</div>

<!-- PAGINATION CONTROLS -->
<div class="d-flex justify-content-center mt-3 mb-5">
    <button id="prev_page" class="btn btn-outline-light me-2" disabled>Previous</button>
    <span id="page_info" class="align-self-center text-light mx-2"></span>
    <button id="next_page" class="btn btn-outline-light ms-2">Next</button>
</div>

<!-- Dữ liệu JSON từ Flask -->
<script id="df_data" type="application/json">
    {{ df_json | safe }}
</script>

<script>
const df = JSON.parse(document.getElementById("df_data").textContent);
const DEFAULT_POSTER = "{{ url_for('static', filename='default_poster.png') }}";
const PAGE_SIZE = 18;
let currentPage = 1;
let filteredMovies = df;

// ====================
// CREATE MOVIE CARD
// ====================
function createMovieCard(movie) {
    const col = document.createElement("div");
    col.className = "col-md-2 mb-4"; // Bootstrap grid 2/12

    const poster = movie.Poster && movie.Poster !== "" ? movie.Poster : DEFAULT_POSTER;

    col.innerHTML = `
        <div class="card h-100 fixed-card">
            <img src="${poster}" class="card-img-top" alt="${movie.Title}" onerror="this.src='${DEFAULT_POSTER}'">
            <div class="card-body d-flex flex-column justify-content-between">
                <h5 class="card-title">${movie.Title}</h5>
                <p class="card-text">
                    <span class="text-year">${movie.Year ? parseInt(movie.Year) : 'N/A'}</span> |
                    <span class="text-rating">${movie.Rating || 'N/A'}</span>
                </p>
                <p class="card-text">${movie.Description ? movie.Description.slice(0, 50) + '...' : ''}</p>
                <a href="/movie/${movie.id}" class="btn btn-outline-info btn-sm mt-2">Details</a>
            </div>
        </div>
    `;
    return col;
}

// ====================
// DISPLAY MOVIES FOR CURRENT PAGE
// ====================
function displayPage(page) {
    const container = document.getElementById("movies_container");
    container.innerHTML = "";

    const start = (page - 1) * PAGE_SIZE;
    const end = Math.min(start + PAGE_SIZE, filteredMovies.length);

    for (let i = start; i < end; i++) {
        container.appendChild(createMovieCard(filteredMovies[i]));
    }

    // Update pagination buttons
    document.getElementById("prev_page").disabled = page === 1;
    document.getElementById("next_page").disabled = end >= filteredMovies.length;

    document.getElementById("page_info").textContent = `Page ${page} of ${Math.ceil(filteredMovies.length / PAGE_SIZE)}`;
}

// ====================
// FILTER + SEARCH
// ====================
function filterMovies() {
    const genre = document.getElementById("feature_filter").value;
    const search = document.getElementById("search_input").value.toLowerCase();

    filteredMovies = df.filter(m => {
        let matchGenre = genre ? (m.Genre && m.Genre.includes(genre)) : true;
        let matchTitle = search ? (m.Title && m.Title.toLowerCase().includes(search)) : true;
        return matchGenre && matchTitle;
    });

    currentPage = 1;
    displayPage(currentPage);
}

// ====================
// EVENT LISTENERS
// ====================
document.getElementById("feature_filter").addEventListener("change", filterMovies);
document.getElementById("search_btn").addEventListener("click", filterMovies);
document.getElementById("search_input").addEventListener("keyup", function(e){
    if(e.key === "Enter") filterMovies();
});

document.getElementById("prev_page").addEventListener("click", () => {
    if(currentPage > 1) {
        currentPage--;
        displayPage(currentPage);
    }
});

document.getElementById("next_page").addEventListener("click", () => {
    if(currentPage * PAGE_SIZE < filteredMovies.length) {
        currentPage++;
        displayPage(currentPage);
    }
});

// ====================
// INITIAL LOAD
// ====================
displayPage(currentPage);
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

<style>
.fixed-card {
    height: 500px; /* chiều cao cố định */
}
.card-img-top {
    height: 400px;
    object-fit: contain;
}
.card {
    background-color: #111;
    color: #00ffff;
    border: 1px solid #00ffff;
    box-shadow: 0 0 10px #00ffff;
    transition: all 0.3s;
}
.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0 20px #00ffff, 0 0 40px #00ffff inset;
}
.card-title {
    font-size: 0.9rem;
    font-weight: bold;
}
.card-text {
    font-size: 0.75rem;
}
.text-rating {
    color: #ff00ff;
    font-weight: bold;
}
.text-year {
    color: #39ff14;
    font-weight: bold;
}
</style>
{% endblock %}
