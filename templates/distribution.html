{% extends "index.html" %}

{% block title %}Distribution{% endblock %}

{% block content %}
<h1>Distribution</h1>
<p>Histogram + Sunburst + Treemap</p>

<!-- JSON -->
<script id="df_data" type="application/json">
    {{ df_json | safe }}
</script>

<!-- Histogram Row -->
<div class="row mb-4">
    <div class="col-md-6">
        <div id="hist_rating" style="width:100%; height:400px;"></div>
    </div>
    <div class="col-md-6">
        <div id="hist_year" style="width:100%; height:400px;"></div>
    </div>
</div>

<!-- Sunburst + Treemap Row -->
<div class="row">
    <div class="col-md-6">
        <div id="sunburst_chart" style="width:100%; height:450px;"></div>
    </div>
    <div class="col-md-6">
        <div id="treemap_chart" style="width:100%; height:450px;"></div>
    </div>
</div>

<script>
/* =============================
   LOAD JSON
============================= */
const df = JSON.parse(document.getElementById("df_data").textContent);

/* =============================
   HISTOGRAM DATA
============================= */
const ratingValues = df
    .filter(r => r.Rating && !isNaN(r.Rating))
    .map(r => parseFloat(r.Rating));

const yearValues = df
    .filter(r => r.Year && !isNaN(r.Year))
    .map(r => parseInt(r.Year));


/* =============================
   HISTOGRAM OF RATING
============================= */
Plotly.newPlot("hist_rating", [{
    x: ratingValues,
    type: "histogram",
    marker: { opacity: 0.7 }
}], {
    title: "Histogram of Ratings",
    paper_bgcolor: "#111",
    plot_bgcolor: "#111",
    font: { color: "#fff" },
    xaxis: { title: "Rating" },
    yaxis: { title: "Count" }
});


/* =============================
   HISTOGRAM OF YEAR
============================= */
Plotly.newPlot("hist_year", [{
    x: yearValues,
    type: "histogram",
    autobinx: false,
    xbins: {
        start: Math.min(...yearValues),
        end: Math.max(...yearValues),
        size: 5
    },
    marker: { opacity: 0.7 }
}], {
    title: "Histogram of Release Year",
    paper_bgcolor: "#111",
    plot_bgcolor: "#111",
    font: { color: "#fff" },
    xaxis: { title: "Year" },
    yaxis: { title: "Count" }
});


/* =============================
   SUNBURST + TREEMAP DATA
============================= */

// Build hierarchy: Genre → Year → Count
let hierarchy = {};

df.forEach(row => {
    if (!row.Genre || !row.Year) return;

    let year = parseInt(row.Year);
    let genres = row.Genre.split(",").map(g => g.trim());

    genres.forEach(g => {
        if (!hierarchy[g]) hierarchy[g] = {};
        if (!hierarchy[g][year]) hierarchy[g][year] = 0;
        hierarchy[g][year]++;
    });
});

// Convert to Plotly format
let labels = ["All Genres"];
let parents = [""];
let values  = [0];  // Root node tạm
// Tính tổng các con và gán cho root
const totalRoot = Object.values(hierarchy).reduce((sumGenre, genreObj) => {
    return sumGenre + Object.values(genreObj).reduce((sumYear, count) => sumYear + count, 0);
}, 0);
values[0] = totalRoot;


for (let genre in hierarchy) {
    labels.push(genre);
    parents.push("All Genres");

    let genreTotal = 0;
    for (let year in hierarchy[genre]) {
        genreTotal += hierarchy[genre][year];
    }
    values.push(genreTotal);

    for (let year in hierarchy[genre]) {
        labels.push(year);
        parents.push(genre);
        values.push(hierarchy[genre][year]);
    }
}

values[0] = values.slice(1).reduce((a,b)=>a+b,0);
/* =============================
   SUNBURST
============================= */
Plotly.newPlot("sunburst_chart", [{
    type: "sunburst",
    labels: labels,
    parents: parents,
    values: values,
    branchvalues: "total"
}], {
    title: "Genre → Year (Sunburst)",
    paper_bgcolor: "#111",
    font: { color: "#fff" },
    margin: { t: 50, l: 0, r: 0, b: 0 },
    sunburstcolorway:["#636efa","#ef553b","#00cc96","#ab63fa","#19d3f3","#e763fa"],
    extendsunburstcolors: true,
    // CHỈNH DOMAIN
    sunburst: { domain: { x: [0, 1], y: [0, 1] } }
});



/* =============================
   TREEMAP
============================= */
Plotly.newPlot("treemap_chart", [{
    type: "treemap",
    labels: labels,
    parents: parents,
    values: values,
    branchvalues: "total"
}], {
    title: "Genre → Year (Treemap)",
    paper_bgcolor: "#111",
    font: { color: "#fff" }
});

</script>

{% endblock %}
